'use strict';const express=require("express"),router=express.Router(),Post=require("../../../models/Post"),Category=require("../../../models/Category"),faker=require("faker"),{userAuth}=require("../../../helpers/authenticate"),{isEmpty}=require("../../../helpers/upload-helpers"),path=require("path"),fs=require("fs");router.all("/*",(b,f,a)=>{b.app.locals.layout="admin";a()});
router.get("/",(b,f)=>{Post.find().populate("category").populate("user").then(a=>{f.render("accounts/admin/posts",{posts:a})}).catch(a=>console.log(`Post Error: ${a}`))});router.get("/create",(b,f)=>{Category.find().then(a=>{f.render("accounts/admin/posts/create-post",{categories:a})})});
router.post("/create",(b,f)=>{var a=[];b.body.title||a.push({message:"Please add title"});b.body.body||a.push({message:"Please add body"});b.body.sub||a.push({message:"Please add sub title"});if(0<a.length)f.render("accounts/admin/posts/create-post",{errors:a});else{a="";if(!isEmpty(b.files.file)){let e=b.files.file;a=Date.now()+"-"+e.name;e.mv("./public/uploads/"+a,d=>{if(d)throw d;})}let c=[];isEmpty(b.files.multi_files)||b.files.multi_files.forEach(e=>{single_image=Date.now()+"-"+e.name;c.push(single_image);
e.mv("./public/uploads/"+single_image,d=>{if(d)throw d;})});(new Post({title:b.body.title,sub:b.body.sub,status:b.body.status,category:b.body.category,file:a,multi_files:c,body:b.body.body,user:"5fb26dd6794fc32960e640c3",date:new Date})).save().then(e=>{b.flash("success_msg",`Post: ${e.title} has been created :)`);f.redirect("/admin/posts")}).catch(e=>console.log(e))}});
router.get("/:id/edit",(b,f)=>{Post.findOne({_id:b.params.id}).then(a=>{Category.find().then(c=>{f.render("accounts/admin/posts/edit",{post:a,categories:c});console.log(c)})})});
router.put("/:id/update",(b,f)=>{Post.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(!isEmpty(b.files.file)){var e=b.files.file;c=Date.now()+"-"+e.name;e.mv("./public/uploads/"+c,d=>{if(d)throw d;});""!==a.file&&"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,d=>{d&&console.log(d)})}e=a.multi_files;isEmpty(b.files.multi_files)?a.multi_files=e:(multi_images_empty=[],b.files.multi_files.forEach(d=>{single_image=Date.now()+"-"+d.name;multi_images_empty.push(single_image);d.mv("./public/uploads/"+
single_image,g=>{if(g)throw g;})}),a.multi_files.forEach(d=>{""!==d&&"img_place.png"!==d&&fs.unlink("./public/uploads/"+d,g=>{g&&console.log(g)})}),a.multi_files.pull(),a.multi_files=multi_images_empty);a.title=b.body.title;a.sub=b.body.sub;a.status=b.body.status;a.category=b.body.category;a.body=b.body.body;a.file=c;a.user="5fb26dd6794fc32960e640c3";a.save().then(d=>{b.flash("success_msg",`Post has successfully been updated. New title is ${d.title}`);f.redirect("/admin/posts")}).catch(d=>console.log(`Updating Error from: ${d}`))}).catch(a=>
console.log(`Error from: ${a}`))});
router.delete("/:id/delete",(b,f)=>{Post.findOne({_id:b.params.id}).then(a=>{"img_place.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,c=>{if(c)throw c;});a.multi_files.forEach(c=>{""!==c&&"img_place.png"!==c&&fs.unlink("./public/uploads/"+c,e=>{e&&console.log(e)})});a.delete().then(c=>{b.flash("success_msg",`Post: "${c.title}" and related comments has been deleted without errors :)`);f.redirect("/admin/posts")}).catch(c=>console.log(`Deleting Error from: ${c}`))}).catch(a=>console.log(`Error: ${a}`))});
router.get("/dummy",(b,f)=>{f.render("admin/dummy")});router.post("/generate-fake-posts",(b,f)=>{for(let a=0;a<b.body.number;a++){let c=new Post;c.title=faker.name.title();c.sub=faker.random.words();c.status="public";c.body=faker.lorem.sentence();c.file="img_place.png";c.file=["img_place.png","img_place.png"];c.slug=faker.name.title();c.user="5fb26dd6794fc32960e640c3";c.date=new Date;c.save().then(e=>{b.flash("success_msg",`Created ${b.body.number} dummy post(s) :)`)}).catch(e=>console.log(e))}f.redirect("/admin/posts")});
router.get("/myPost/:id",(b,f)=>{Post.find({user:b.params.id}).populate("user").populate("category").then(a=>{f.render("accounts/admin/posts/loggedInUser_Post",{posts:a})}).catch(a=>console.log(a))});module.exports=router;