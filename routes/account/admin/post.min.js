'use strict';const express=require("express"),router=express.Router(),Post=require("../../../models/Post"),Category=require("../../../models/Category"),faker=require("faker"),{userAuth}=require("../../../helpers/authenticate"),{isEmpty}=require("../../../helpers/upload-helpers"),path=require("path"),fs=require("fs");router.all("/*",(b,e,a)=>{b.app.locals.layout="admin";a()});
router.get("/",(b,e)=>{Post.find().populate("category").populate("user").then(a=>{e.render("accounts/admin/posts",{posts:a})}).catch(a=>console.log(`Post Error: ${a}`))});router.get("/create",(b,e)=>{Category.find().then(a=>{e.render("accounts/admin/posts/create-post",{categories:a})})});
router.post("/create",(b,e)=>{var a=[];b.body.title||a.push({message:"Please add title"});b.body.body||a.push({message:"Please add body"});b.body.sub||a.push({message:"Please add sub title"});if(0<a.length)e.render("accounts/admin/posts/create-post",{errors:a});else{a="";if(!isEmpty(b.files.file)){let d=b.files.file;a=Date.now()+"-"+d.name;d.mv("./public/uploads/"+a,g=>{if(g)throw g;})}let c=[];isEmpty(b.files.multi_files)||b.files.multi_files.forEach(d=>{single_image=Date.now()+"-"+d.name;c.push(single_image);
d.mv("./public/uploads/"+single_image,g=>{if(g)throw g;})});(new Post({title:b.body.title,sub:b.body.sub,status:b.body.status,category:b.body.category,file:a,multi_files:c,body:b.body.body,user:b.session.user,date:new Date})).save().then(d=>{b.flash("success_msg",`Post: ${d.title} has been created :)`);e.redirect("/admin/posts")}).catch(d=>console.log(d))}});
router.get("/:id/edit",(b,e)=>{Post.findOne({_id:b.params.id}).then(a=>{Category.find().then(c=>{e.render("accounts/admin/posts/edit",{post:a,categories:c});console.log(c)})})});
router.put("/:id/update",(b,e)=>{Post.findOne({_id:b.params.id}).then(a=>{let c=a.file;if(b.files.file){var d=b.files.file;c=Date.now()+"-"+d.name;d.mv("./public/uploads/"+c,f=>{if(f)throw f;});""!==a.file&&"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,f=>{f&&console.log(f)})}d=a.multi_files;let g=[];b.files.multi_files?(b.files.multi_files.forEach(f=>{single_image=Date.now()+"-"+f.name;g.push(single_image);f.mv("./public/uploads/"+single_image,h=>{if(h)throw h;})}),a.multi_files.forEach(f=>
{""!==f&&"img_place.png"!==f&&fs.unlink("./public/uploads/"+f,h=>{h&&console.log(h)})}),a.multi_files="empty",a.multi_files=g):a.multi_files=d;a.title=b.body.title;a.sub=b.body.sub;a.status=b.body.status;a.category=b.body.category;a.body=b.body.body;a.file=c;a.user=b.session.user;a.save().then(f=>{b.flash("success_msg",`Post has successfully been updated. New title is ${f.title}`);e.redirect("/admin/posts")}).catch(f=>console.log(`Updating Error from: ${f}`))}).catch(a=>console.log(`Can't find post due to error from: ${a}`))});
router.delete("/:id/delete",(b,e)=>{Post.findOne({_id:b.params.id}).then(a=>{"img_place.png"!==a.file&&""!==a.file&&fs.unlink("./public/uploads/"+a.file,c=>{if(c)throw c;});a.multi_files.forEach(c=>{""!==c&&"img_place.png"!==c&&fs.unlink("./public/uploads/"+c,d=>{d&&console.log(d)})});a.delete().then(c=>{b.flash("success_msg",`Post: "${c.title}" and related comments has been deleted without errors :)`);e.redirect("/admin/posts")}).catch(c=>console.log(`Deleting Error from: ${c}`))}).catch(a=>console.log(`Error: ${a}`))});
router.get("/dummy",(b,e)=>{e.render("admin/dummy")});router.post("/generate-fake-posts",(b,e)=>{for(let a=0;a<b.body.number;a++){let c=new Post;c.title=faker.name.title();c.sub=faker.random.words();c.status="public";c.body=faker.lorem.sentence();c.file="img_place.png";c.file=["img_place.png","img_place.png"];c.slug=faker.name.title();c.user=b.session.user;c.date=new Date;c.save().then(d=>{b.flash("success_msg",`Created ${b.body.number} dummy post(s) :)`)}).catch(d=>console.log(d))}e.redirect("/admin/posts")});
router.get("/myPost/:id",(b,e)=>{Post.find({user:b.params.id}).populate("user").populate("category").then(a=>{e.render("accounts/admin/posts/loggedInUser_Post",{posts:a})}).catch(a=>console.log(a))});module.exports=router;