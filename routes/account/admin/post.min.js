'use strict';const express=require("express"),router=express.Router(),Post=require("../../models/Post"),faker=require("faker"),{isEmpty,uploadDir}=require("../../helpers/upload-helper"),path=require("path"),fs=require("fs"),Category=require("../../models/Category"),{userAuth}=require("../../helpers/authenticate");router.all("/*",userAuth,(b,e,c)=>{b.app.locals.layout="admin";c()});
router.get("/",(b,e)=>{Post.find({}).populate("category").populate("user").then(c=>{e.render("admin/posts",{posts:c})}).catch(c=>console.log("Post Error: err"))});router.get("/create",(b,e)=>{Category.find().then(c=>{e.render("admin/posts/create-post",{categories:c})})});
router.post("/create",(b,e)=>{var c=[];b.body.title||c.push({message:"Please add title"});b.body.body||c.push({message:"Please add body"});b.body.sub||c.push({message:"Please add sub title"});if(0<c.length)e.render("admin/posts/create-post",{errors:c});else{c=Date.now()+"-img_place.png";if(!isEmpty(b.files.file)){let d=b.files.file;c=Date.now()+"-"+d.name;d.mv("./public/uploads/"+c,h=>{if(h)throw h;})}let a=[];isEmpty(b.files.multi_files)||b.files.multi_files.forEach(d=>{filenames=Date.now()+"-"+
d.name;a.push(filenames);d.mv("./public/uploads/"+filenames,h=>{if(h)throw h;})});(new Post({title:b.body.title,sub:b.body.sub,status:b.body.status,category:b.body.category,allowComments,file:c,multi_files:a,body:b.body.body,user:"5fb3b150d9d74f0ff44cba77",date:new Date})).save().then(d=>{console.log(`Sent Post: ${d}`);b.flash("success_msg",`Post: ${d.title} has been created :)`);e.redirect("/admin/posts")}).catch(d=>console.log(d))}});
router.get("/:id/edit",(b,e)=>{Post.findOne({_id:b.params.id}).then(c=>{Category.find().then(a=>{console.log(`Single post: ${c}`);e.render("admin/posts/edit",{post:c,categories:a});console.log(a)})})});
router.post("/:id/update",(b,e)=>{let c=!0;c=b.body.allowComments?!0:!1;Post.findOne({_id:b.params.id}).then(a=>{console.log(a);let d=a.file;if(!isEmpty(b.files)){let f=b.files.file;d=Date.now()+"-"+f.name;f.mv("./public/uploads/"+d,g=>{if(g)throw g;});""!==a.file&&"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,g=>{g&&console.log(g)})}let h=[a.multi_files];isEmpty(b.files.multi_files)||(b.files.multi_files.forEach(f=>{filenames=Date.now()+"-"+f.name;h.push(filenames);f.mv("./public/uploads/"+
filenames,g=>{if(g)throw g;})}),a.multi_files.forEach(f=>{""!==f&&"img_place.png"!==f&&fs.unlink("./public/uploads/"+f,g=>{g&&console.log(g)})}));a.title=b.body.title;a.sub=b.body.sub;a.status=b.body.status;a.category=b.body.category;a.body=b.body.body;a.allowComments=c;a.file=d;a.user=b.user.id;a.save().then(f=>{console.log(`New Post: ${f}`);console.log("Updated Successfully");b.flash("success_msg",`Post has successfully been updated. New title is ${f.title}`);e.redirect("/admin/posts")}).catch(f=>
console.log(`Updating Error from: ${f}`))}).catch(a=>console.log(`Error from: ${a}`))});
router.get("/:id/delete",(b,e)=>{Post.findOne({_id:b.params.id}).populate("comments").then(c=>{console.log(c);"img_place.png"!==c.file&&fs.unlink("./public/uploads/"+c.file,a=>{if(a)throw a;});1>!c.comments.length&&c.comments.forEach(a=>{a.delete().then(d=>{console.log(`Comments Deleted ${d}`)}).catch(d=>console.log(d))});c.delete().then(a=>{console.log(`Post Deleted: ${a}`);b.flash("success_msg",`Post: "${a.title}" and related comments has been deleted without errors :)`);e.redirect("/admin/posts")}).catch(a=>
console.log(`Deleting Error from: ${a}`))}).catch(c=>console.log(`Error: ${c}`))});router.get("/dummy",(b,e)=>{e.render("admin/dummy")});
router.post("/generate-fake-posts",(b,e)=>{for(let c=0;c<b.body.number;c++){let a=new Post;a.title=faker.name.title();a.sub=faker.random.words();a.status="public";a.allowComments=faker.random.boolean();a.body=faker.lorem.sentence();a.file="img_place.png";a.file=["img_place.png","img_place.png"];a.slug=faker.name.title();a.user="5fb3b150d9d74f0ff44cba77";a.date=new Date;a.save().then(d=>{b.flash("success_msg",`Created ${b.body.number} dummy post(s) :)`)}).catch(d=>console.log(d))}e.redirect("/admin/posts")});
router.get("/myPost/:id",(b,e)=>{Post.find({user:b.params.id}).populate("user").populate("category").then(c=>{e.render("admin/posts/loggedInUser_Post",{posts:c})}).catch(c=>console.log(c))});module.exports=router;