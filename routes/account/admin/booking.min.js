'use strict';"production"!==process.env.NODE_ENV&&require("dotenv").config();const stripeSecretKey=process.env.STRIPE_SECRET_KEY,stripePubKey=process.env.STRIPE_PUBLISHABLE_KEY,stripe=require("stripe")(stripeSecretKey),express=require("express"),app=express(),router=require("express-promise-router")(),Booking=require("../../../models/Booking"),Destination=require("../../../models/Destination");router.all("/*",(b,c,a)=>{b.app.locals.layout="admin";a()});
router.post("/create-checkout-session",async(b,c,a)=>{console.log(b.body.price);try{const d=await stripe.checkout.sessions.create({success_url:"http://localhost:5555/success?id={CHCECKOUT_SESSION_ID}",cancel_url:"http://localhost:5555/error?id={CHECKOUT_SESSION_ID}",payment_method_types:["card"],mode:"payment",line_items:[{price_data:b.body.price}]});c.json({id:d.id})}catch(d){a(d)}});
router.get("/",(b,c)=>{Booking.find().where("status").equals("active").populate("user").then(a=>{c.render("accounts/admin/booking",{bookings:a})}).catch(a=>console.log(a))});router.get("/cancelled",(b,c)=>{Booking.find().where("status").equals("unactive").populate("user").then(a=>{c.render("accounts/admin/booking/cancelled",{bookings:a})}).catch(a=>console.log(a))});
router.get("/:id/loggedUser",(b,c)=>{Booking.find({user:b.params.id}).populate("user").then(a=>{c.render("accounts/admin/booking/loggedUser",{bookings:a})}).catch(a=>console.log(a))});router.get("/create",(b,c)=>{Destination.find().then(a=>{c.render("accounts/admin/booking/create",{destinations:a,stripePubKey})}).catch(a=>console.log(a))});
router.get("/edit/:id",(b,c)=>{Booking.findOne({_id:b.params.id}).where("status").equals("active").then(a=>{Destination.find().then(d=>{c.render("accounts/admin/booking/edit",{booking:a,destinations:d})}).catch(d=>console.log(d))}).catch(a=>console.log(a))});router.get("/show/:id",(b,c)=>{Booking.findOne({_id:b.params.id}).where("status").equals("active").then(a=>{c.render("accounts/admin/booking/show",{booking:a})}).catch(a=>console.log(a))});
router.post("/create",(b,c)=>{const a=new Booking;a.location=b.body.location;a.destination=b.body.destination;a.booking_time=b.body.booking_time;a.booking_date=b.body.booking_date;a.price=b.body.price;a.plan=b.body.plan;a.date=new Date;a.user="5fb26dd6794fc32960e640c3";a.save().then(d=>{b.flash("success_msg","Taxi booking process has been completed : )");c.redirect("/admin/booking")}).catch(d=>console.log(d))});
router.get("/stripe_payout",(b,c)=>{stripe.customer.create({email:b.body.stripeEmail,source:b.body.stripeToken,name:"jOHN",address:{line1:"PHC Nigeria",postal_code:"4401101",city:"PHC",state:"Riv State",country:"Nig"}}).then(a=>stripe.charges.create({amount:100*parseFloat(b.body.plan.replace("$","")),description:`Booking Taxi from ${b.body.from} to ${b.body.to} on ${b.body.plan}`,currency:"USD",customer:a.id})).then(a=>{c.redirect("back")}).catch(a=>console.log(a))});
router.put("/:id/update",(b,c)=>{Booking.findOne({_id:b.params.id}).then(a=>{a.location=b.body.location;a.destination=b.body.destination;a.booking_time=b.body.booking_time;a.booking_date=b.body.booking_date;newBooking.price=b.body.price;newBooking.plan=b.body.plan;a.date=new Date;newBooking.user=b.user.id;a.save().then(d=>{b.flash("success_msg","Taxi booking info has been updated successfully : )");c.redirect("/admin/booking")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.get("/cancel/:id",(b,c)=>{Booking.findOne({_id:b.params.id}).where("status").equals("active").then(a=>{a.status="unactive";a.save().then(d=>{b.flash("success_msg","Taxi booking has been cancelled successfully : )");c.redirect("/admin/booking/cancelled")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.get("/retrieve/:id",(b,c)=>{Booking.findOne({_id:b.params.id}).where("status").equals("unactive").then(a=>{a.status="active";a.save().then(d=>{b.flash("success_msg","Taxi booking has been retrieved successfully : )");c.redirect("/admin/booking")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.delete("/:id/delete",(b,c)=>{Booking.findOne({_id:b.params.id}).then(a=>{a.delete().then(d=>{b.flash("success_msg","Taxi booking info has been deleted successfully : )");c.redirect("/admin/booking")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});module.exports=router;