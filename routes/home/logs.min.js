'use strict';const express=require("express"),app=express(),User=require("../../models/User"),bcrypt=require("bcryptjs"),router=express.Router();router.all("/*",(a,c,b)=>{a.app.locals.layout="logs";b()});router.get("/sign",(a,c)=>{a.session.user&&("Admin"===a.session.user.role?User.findOne({_id:a.session.user}).then(b=>{a.session.user=b;c.redirect("/admin")}).catch(b=>console.log(b)):User.findOne({_id:a.session.user}).then(b=>{a.session.user=b;c.redirect("/user")}).catch(b=>console.log(b)));c.render("home/logs")});
router.post("/login",(a,c)=>{User.findOne({email:a.body.email}).then(b=>{b?bcrypt.compare(a.body.password,b.password,(d,e)=>{d&&console.log(d);e?"Admin"===b.role?(a.session.user=b,c.redirect("/admin"),console.log("User logged in as a Admin")):(a.session.user=b,c.redirect("/user"),console.log("User logged in as a Subscriber")):(a.flash("error_msg","Password mismatch. Try again ): "),c.redirect("back"))}):(a.flash("error_msg","Email not recognised. Try again ): "),c.redirect("back"))})});
router.post("/register",(a,c)=>{User.findOne({email:a.body.email}).then(b=>{if(b)a.flash("error_msg","User exists with email ):"),c.redirect("back");else{const d=new User;d.email=a.body.email;d.phone=a.body.phone;d.password=a.body.password;bcrypt.genSalt(10,(e,h)=>{bcrypt.hash(a.body.password,h,(f,k)=>{f&&console.log(f);d.password=k;d.save().then(g=>{a.flash("success_msg","Account created. Sign in buddy :) ");c.redirect("back")}).catch(g=>console.log(g))})})}}).catch(b=>console.log(b))});
router.get("/logout",(a,c)=>{a.session.user="";c.redirect("/")});module.exports=router;